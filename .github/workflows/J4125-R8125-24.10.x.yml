name: J4125-R8125

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
      custom_router_ip:
        description: "è¯·è®¾ç½®è·¯ç”±å™¨çš„ç®¡ç†åœ°å€(ä»…å¯¹å¤šç½‘å£è·¯ç”±å™¨æœ‰æ•ˆ) æ ¼å¼:192.168.x.1 æˆ– 10.x.x.1"
        required: true
        default: "192.168.0.1"
      profile:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶å¤§å° å•ä½(MB)'
        required: true
        default: '2048'
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: false
      

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code ï¼ˆæ£€æŸ¥æºç ï¼‰
        uses: actions/checkout@v3

      - name: Set executable permissions ï¼ˆè®¾ç½®ç¯å¢ƒï¼‰
        run: chmod +x ${{ github.workspace }}/x86-64/build24.sh

      - name: Save Custom Router IP into OpenWrt files ï¼ˆè®¾ç½®ç®¡ç†åœ°å€ï¼‰
        run: |
          mkdir -p "${{ github.workspace }}/custom"
          echo "${{ github.event.inputs.custom_router_ip }}" > "${{ github.workspace }}/custom/custom_router_ip.txt"
          echo "æ‚¨è®¾ç½®çš„è·¯ç”±å™¨ç®¡ç†åœ°å€æ˜¯:${{ github.event.inputs.custom_router_ip }}"
          # åç»­æ­¥éª¤ä¼šå°†è¯¥æ–‡ä»¶æ˜ å°„åˆ°è·¯ç”±å™¨/etc/config/custom_router_ip.txt ä»¥ä¾¿ç”¨äºå¼€æœºè„šæœ¬99-custom.shè¯»å–ç”¨æˆ·è®¾ç½®çš„ip
      
   
      - name: Enable Store integration ï¼ˆé›†æˆstoreï¼‰
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
            echo "âœ… å·²è¿½åŠ  luci-app-store"
          else
            echo "â æœªå¯ç”¨ luci-app-store"
          fi

      - name: Build ImmortalWrt-x86-64-efi ï¼ˆå¼€å§‹ç¼–è¯‘å›ºä»¶ï¼‰
        run: |
          profile="${{ github.event.inputs.profile }}"
          include_docker="${{ github.event.inputs.include_docker }}"
          luci_version="${{ github.event.inputs.luci_version }}"
          echo "Building for profile: $profile"
          docker run --rm -i \
            --user root \
            -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
            -v "${{ github.workspace }}/files:/home/build/immortalwrt/files" \
            -v "${{ github.workspace }}/custom:/home/build/immortalwrt/files/etc/config" \
            -v "${{ github.workspace }}/x86-64/imm.config:/home/build/immortalwrt/.config" \
            -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
            -v "${{ github.workspace }}/x86-64/build24.sh:/home/build/immortalwrt/build.sh" \
            -e PROFILE=$profile \
            -e INCLUDE_DOCKER=$include_docker \
           
          immortalwrt/imagebuilder:x86-64-openwrt-${luci_version} /bin/bash /home/build/immortalwrt/build.sh
          

      - name: Create info ï¼ˆæ›´æ–°å‘å¸ƒé¡µä¿¡æ¯ï¼‰
        run: |
          cat > ${{ github.workspace }}/router-info.md <<EOF
          ## ğŸ“¡ J4125 + R8125 ç‰©ç†æœºä¸“å±å›ºä»¶
          
          > **æ³¨æ„**: æœ¬å›ºä»¶ä¸“ä¸º J4125 è£¸æœºè®¾è®¡ï¼Œå·²å‰”é™¤æ‰€æœ‰è™šæ‹ŸåŒ–é©±åŠ¨åŠ Dockerã€‚

          - ğŸ  **åå°åœ°å€**: [http://${{ github.event.inputs.custom_router_ip }}](http://${{ github.event.inputs.custom_router_ip }})
          - ğŸ‘¤ **ç”¨æˆ·å**: root
          - ğŸ”‘ **å¯†ç **: password (æˆ–æ— )
          - ğŸš€ **ç‰¹æ€§**: 2.5G ç½‘å¡é©±åŠ¨ä¼˜åŒ–ã€ç¡¬ä»¶æµé‡åˆ†è½½åŠ é€Ÿã€é˜²ç«å¢™å®‰å…¨é˜²æŠ¤(é»˜è®¤æ‹’ç»WANå…¥ç«™)
          
          ---
          #### ğŸ“¦ ç»„ä»¶é›†æˆçŠ¶æ€
          EOF

          if [ "${{ github.event.inputs.include_docker }}" == "yes" ]; then
            echo "- âœ… å·²é›†æˆ Docker ç¯å¢ƒ" >> ${{ github.workspace }}/router-info.md
          else
            echo "- âŒ çº¯å‡€æ¨¡å¼ï¼šæœªé›†æˆ Docker" >> ${{ github.workspace }}/router-info.md
          fi
          
          echo "- ğŸŒ Wanè®¾ç½®: è‡ªåŠ¨ DHCP" >> ${{ github.workspace }}/router-info.md
          echo "- ğŸ“… ç¼–è¯‘æ—¶é—´: $(date +'%Y-%m-%d %H:%M')" >> ${{ github.workspace }}/router-info.md

      - name: Rename files for clarity (æ›´æ”¹åç§°)
        run: |
          # è¿›å…¥ç›®æ ‡ç›®å½•
          cd ${{ github.workspace }}/bin/targets/x86/64/
          
          # æ ¸å¿ƒä¿®å¤ï¼šä¿®æ”¹å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„æ‰€æœ‰æƒä¸ºå½“å‰ç”¨æˆ·
          sudo chown -R $USER:$USER .
          
          # å®šä¹‰æ—¥æœŸå’Œç‰ˆæœ¬å˜é‡
          DATE=$(date +%Y%m%d)
          VER="${{ github.event.inputs.luci_version }}"
          
          # 1. é‡å‘½å Squashfs é•œåƒ (æ·»åŠ  efi)
          [ -f *squashfs-combined-efi.img.gz ] && mv -f *squashfs-combined-efi.img.gz J4125-Immortalwrt-$VER-Squashfs-efi-$DATE.img.gz || echo "No Squashfs found"
          
          # 2. é‡å‘½å Ext4 é•œåƒ (æ·»åŠ  efi)
          [ -f *ext4-combined-efi.img.gz ] && mv -f *ext4-combined-efi.img.gz J4125-Immortalwrt-$VER-Ext4-efi-$DATE.img.gz || echo "No Ext4 found"
          
          # 3. é‡å‘½å Sysupgrade å‡çº§åŒ…
          [ -f *squashfs-sysupgrade.bin ] && mv -f *squashfs-sysupgrade.bin J4125-Immortalwrt-$VER-Sysupgrade-$DATE.bin || echo "No Sysupgrade found"
          
          # åˆ—å‡ºç»“æœéªŒè¯
          ls -lh J4125-Immortalwrt-*
      - name: Upload ImmortWrt as release assets (å‘å¸ƒå›ºä»¶)
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: J4125-R8125-${{ github.run_id }}
          # è¿™é‡Œçš„ files åŒ¹é…æ¨¡å¼ä¹Ÿè¦ç›¸åº”ä¿®æ”¹ä»¥åŒ¹é…æ–°çš„å‰ç¼€
          files: |
            ${{ github.workspace }}/bin/targets/x86/64/J4125-Immortalwrt-*.img.gz
            ${{ github.workspace }}/bin/targets/x86/64/J4125-Immortalwrt-*.bin
          token: ${{ secrets.GITHUB_TOKEN }}
